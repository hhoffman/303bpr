---
- name: Ensure CPU supports KVM acceleration
  command: egrep -c '(vmx|svm)' /proc/cpuinfo
  register: kvm_support
  changed_when: false
  failed_when: kvm_support.stdout == "0"

- name: Install KVM and required packages
  apt:
    name:
      - qemu-kvm
      - libvirt-daemon-system
      - libvirt-clients
      - bridge-utils
      - libosinfo-bin
      - virt-top
      - libguestfs-tools
    state: present
  when: kvm_support.stdout != "0"

- name: Check if ansible user exists
  getent:
    database: passwd
    key: ansible
  register: ansible_user
  changed_when: false

- name: Create ansible group if it does not exist
  group:
    name: ansible
    state: present
  when: ansible_user is not defined

- name: Create ansible user if it does not exist
  user:
    name: ansible
    group: ansible
    state: present
  when: ansible_user is not defined

- name: Add ansible user to libvirt group
  user:
    name: ansible
    groups: libvirt
    append: yes

- name: Add ansible user to kvm group
  user:
    name: ansible
    groups: kvm
    append: yes

- name: Ensure libvirt service is started and enabled
  service:
    name: libvirtd
    state: started
    enabled: yes
    
- name: Create VLAN configuration files
  template:
    src: vlan_template.xml.j2
    dest: "/etc/libvirt/qemu/networks/kvmbr{{ item }}.xml"
  with_items: "{{ vlans }}"

- name: Check if network is already defined
  command: "virsh net-info kvmbr{{ item }}"
  register: net_info
  ignore_errors: yes
  with_items: "{{ vlans }}"

- name: Define the network if not already defined
  command: "virsh net-define /etc/libvirt/qemu/networks/kvmbr{{ item }}.xml"
  with_items: "{{ vlans }}"
  when: net_info.results[item.ansible_loop.index0].rc != 0
  ignore_errors: yes

- name: Check if network is active
  command: "virsh net-list --all | grep kvmbr{{ item }}"
  register: net_list
  ignore_errors: yes
  with_items: "{{ vlans }}"

- name: Start the network if not already started
  command: "virsh net-start kvmbr{{ item }}"
  with_items: "{{ vlans }}"
  when: net_list.results[item.ansible_loop.index0].stdout.find('active') == -1
  ignore_errors: yes

- name: Check if network is set to autostart
  command: "virsh net-list --autostart | grep kvmbr{{ item }}"
  register: net_autostart
  ignore_errors: yes
  with_items: "{{ vlans }}"

- name: Ensure network is set to autostart
  command: "virsh net-autostart kvmbr{{ item }}"
  with_items: "{{ vlans }}"
  when: net_autostart.results[item.ansible_loop.index0].rc != 0
  ignore_errors: yes
